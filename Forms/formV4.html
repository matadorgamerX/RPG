<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Ficha +2D6 Dark Fantasy - Kuar-Tor Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;500;700&family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .title-font { font-family: 'Cinzel', serif; }
        .content-font { font-family: 'MedievalSharp', cursive; }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .attribute-input { 
            width: 60px;
            background-color: #1f2937;
            border: 1px solid #4b5563;
            color: #d1d5db;
            text-align: center;
            border-radius: 0.375rem;
            padding: 0.5rem;
        }
        .attribute-input:focus {
            outline: none;
            border-color: #ef4444;
            box-shadow: 0 0 0 2px #ef444460;
        }
        
        .section-card {
            background-color: #1f2937;
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid #374151;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .section-title {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            color: #f87171;
            border-bottom: 2px solid #374151;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .action-button { border: 1px solid #52525b; transition: background-color 0.2s, border-color 0.2s; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .action-button-primary { background-color: #7f1d1d; color: #fecaca; border-color: #991b1b; }
        .action-button-primary:hover { background-color: #991b1b; }
        .action-button-secondary { background-color: #52525b; color: #d4d4d8; border-color: #71717a; }
        .action-button-secondary:hover { background-color: #71717a; }
        .action-button-main { background-color: #047857; color: #d1fae5; font-weight: 600; border: 1px solid #065f46; }
        .action-button-main:hover { background-color: #065f46; }
        .action-button-import { background-color: #4338ca; color: #e0e7ff; font-weight: 600; border: 1px solid #3730a3; }
        .action-button-import:hover { background-color: #3730a3; }

        .points-counter { background-color: rgba(0,0,0,0.2); border: 1px solid #3f3f46; border-radius: 0.5rem; padding: 0.75rem 1rem; margin-bottom: 1.5rem; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 1rem; }
        .points-block { text-align: center; }
        .points-label { font-size: 0.8rem; color: #a1a1aa; text-transform: uppercase; }
        .points-value { font-family: 'Cinzel', serif; font-size: 1.5rem; font-weight: bold; color: #f5f5f5; }
        .points-value.negative { color: #ef4444; }

        .modal { position: fixed; inset: 0; background-color: rgba(10, 10, 10, 0.85); display: flex; align-items: center; justify-content: center; padding: 1rem; z-index: 1000; }
        .modal-content { background-color: #18181b; border: 1px solid #3f3f46; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5), 0 10px 10px -5px rgba(0,0,0,0.4); max-width: 48rem; width: 100%; color: #a3a3a3; }
        .modal-title { font-family: 'Cinzel', serif; font-size: 1.5rem; font-weight: 700; color: #f5f5f5; }
        .modal-close-button { color: #a3a3a3; background: none; border: none; font-size: 1.75rem; cursor: pointer; line-height: 1; }
        .modal-close-button:hover { color: #e5e5e5; }
        .modal-body { max-height: 70vh; overflow-y: auto; }

        .pvd-item { display: flex; align-items: flex-start; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid #3f3f46; }
        .pvd-item:last-child { border-bottom: none; }
        .pvd-item-details strong { color: #e5e7eb; }
        .pvd-item-details .description { display: block; font-size: 0.8rem; color: #a1a1aa; margin-top: 0.25rem; white-space: normal; }

        @media print {
            body { background-color: #ffffff !important; color: #000 !important; }
            .no-print, #rpgSheetForm, #mainTitle, #savedSheetsSection { display: none !important; }
            #generatedSheet { display: block !important; box-shadow: none !important; border: none !important; color: #000 !important; }
            .section-card { background-color: #fff !important; border: 1px solid #ccc !important; }
            .section-title { color: #000 !important; border-color: #ccc !important; }
            #sheetContent p, #sheetContent li, #sheetContent h3, #sheetContent h4, #sheetContent span, #sheetContent strong { color: #000 !important; }
        }
    </style>
</head>
<body class="bg-neutral-900 text-neutral-300 min-h-screen flex flex-col items-center pt-8 pb-12 px-4">

    <div class="w-full max-w-3xl">
        <header class="text-center mb-8 no-print">
            <h1 id="mainTitle" class="text-4xl md:text-5xl title-font text-red-500">Kuar-Tor: Ecos do Vazio</h1>
            <p class="content-font text-xl text-gray-400 mt-2">Ficha de Personagem Unificada</p>
        </header>

        <div class="w-full bg-neutral-800 p-6 sm:p-8 rounded-lg shadow-2xl border border-neutral-700 no-print">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h1 class="title-font text-3xl sm:text-4xl font-bold text-center text-amber-500">Gerador de Fichas</h1>
                <div class="flex space-x-3">
                    <button type="button" id="importSheetButton" class="px-5 py-2.5 action-button-import rounded-md shadow-md text-sm">Importar Ficha</button>
                    <button type="button" id="generateFullCharButton" class="px-5 py-2.5 action-button-main rounded-md shadow-md text-sm">✨ Gerar Personagem</button>
                </div>
            </div>
            <input type="file" id="fileInput" accept=".json" class="hidden">

            <!-- Contador de Pontos -->
            <div id="pointCounterSection" class="points-counter">
                <div class="points-block"><div class="points-label">Atributos</div><div id="attributePointsValue" class="points-value">0/12</div></div>
                <div class="points-block"><div class="points-label">Perícias</div><div id="skillPointsValue" class="points-value">0/10</div></div>
                <div class="points-block"><div class="points-label">Vantagens</div><div id="advantagePointsValue" class="points-value">0/0</div></div>
                <div class="points-block"><div class="points-label">Caminhos</div><div id="magicPathPointsValue" class="points-value">0/0</div></div>
            </div>

            <form id="rpgSheetForm" class="space-y-6">
                <!-- Informações Básicas -->
                <fieldset class="border border-neutral-700 p-4 rounded-md">
                    <legend class="text-lg px-2 section-title !border-none !mb-0 !pb-0 !text-amber-500">Identidade</legend>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                         <div><label for="charName" class="block text-sm font-medium mb-1">Nome:</label><input type="text" id="charName" name="charName" required class="w-full p-2 bg-neutral-900 border-neutral-600 rounded-md"></div>
                         <div><label for="charRace" class="block text-sm font-medium mb-1">Raça:</label><input type="text" id="charRace" name="charRace" class="w-full p-2 bg-neutral-900 border-neutral-600 rounded-md"></div>
                         <div><label for="charClass" class="block text-sm font-medium mb-1">Classe:</label><input type="text" id="charClass" name="charClass" class="w-full p-2 bg-neutral-900 border-neutral-600 rounded-md"></div>
                    </div>
                </fieldset>
                
                <!-- Evolução -->
                 <fieldset class="border border-neutral-700 p-4 rounded-md">
                    <legend class="text-lg px-2 section-title !border-none !mb-0 !pb-0 !text-amber-500">Evolução & Experiência</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                        <div>
                            <label for="expPoints" class="block text-sm font-medium mb-1">Pontos de Experiência (EXP):</label>
                            <input type="number" id="expPoints" name="expPoints" min="0" value="0" class="w-full p-2 bg-neutral-900 border-neutral-600 rounded-md">
                        </div>
                        <div class="bg-neutral-900/50 p-3 rounded-md border border-neutral-700 space-y-2">
                            <div class="flex justify-between text-sm"><span class="text-neutral-400">Pontos de Atributo Ganhos:</span><span id="earnedAttributePoints" class="font-bold text-amber-400">0</span></div>
                            <div class="flex justify-between text-sm"><span class="text-neutral-400">Pontos de Evolução Ganhos:</span><span id="earnedEvolutionPoints" class="font-bold text-amber-400">0</span></div>
                            <hr class="border-neutral-700">
                            <div class="flex justify-between text-sm"><span class="text-neutral-400">Pontos de Evolução Disponíveis:</span><span id="availableEvolutionPoints" class="font-bold text-green-400">0</span></div>
                            <div class="flex justify-center space-x-2 pt-2">
                                <button type="button" id="spendOnSkillButton" class="text-xs action-button action-button-secondary px-2 py-1 disabled:opacity-50 disabled:cursor-not-allowed" title="Gasta 1 Ponto de Evolução para ganhar +1 Ponto de Perícia.">+1 para Perícias</button>
                                <button type="button" id="spendOnAdvantageButton" class="text-xs action-button action-button-secondary px-2 py-1 disabled:opacity-50 disabled:cursor-not-allowed" title="Gasta 1 Ponto de Evolução para ganhar +1 Ponto para Vantagens.">+1 para Vantagens</button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="pontosPericiaAdicionais" id="pontosPericiaAdicionais" value="0">
                    <input type="hidden" name="pontosVantagemAdicionais" id="pontosVantagemAdicionais" value="0">
                </fieldset>

                <!-- Atributos -->
                <fieldset class="border border-neutral-700 p-4 rounded-md">
                    <legend class="text-lg px-2 section-title !border-none !mb-0 !pb-0 !text-amber-500">Atributos</legend>
                    <div class="grid grid-cols-3 md:grid-cols-7 gap-4 justify-items-center text-center">
                        <div><label for="for" class="block text-lg font-bold title-font text-gray-300">FOR</label><input type="number" id="for" name="for" class="attribute-input mt-1" value="2" min="1" max="5"></div>
                        <div><label for="des" class="block text-lg font-bold title-font text-gray-300">DES</label><input type="number" id="des" name="des" class="attribute-input mt-1" value="2" min="1" max="5"></div>
                        <div><label for="con" class="block text-lg font-bold title-font text-gray-300">CON</label><input type="number" id="con" name="con" class="attribute-input mt-1" value="2" min="1" max="5"></div>
                        <div><label for="int" class="block text-lg font-bold title-font text-gray-300">INT</label><input type="number" id="int" name="int" class="attribute-input mt-1" value="2" min="1" max="5"></div>
                        <div><label for="sab" class="block text-lg font-bold title-font text-gray-300">SAB</label><input type="number" id="sab" name="sab" class="attribute-input mt-1" value="2" min="1" max="5"></div>
                        <div><label for="pod" class="block text-lg font-bold title-font text-gray-300">POD</label><input type="number" id="pod" name="pod" class="attribute-input mt-1" value="2" min="1" max="5"></div>
                        <div><label for="car" class="block text-lg font-bold title-font text-gray-300">CAR</label><input type="number" id="car" name="car" class="attribute-input mt-1" value="2" min="1" max="5"></div>
                    </div>
                </fieldset>

                <!-- Habilidades -->
                <fieldset class="border border-neutral-700 p-4 rounded-md">
                    <legend class="text-lg px-2 section-title !border-none !mb-0 !pb-0 !text-amber-500">Habilidades & Peculiaridades</legend>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-1"><label class="block text-sm font-medium">Perícias:</label><button type="button" id="manageSkillsButton" class="text-sm action-button action-button-secondary px-3 py-1">Gerir Perícias</button></div>
                            <div id="displaySkills" class="p-2 min-h-[40px] bg-neutral-900/50 rounded-md border border-neutral-600 text-sm italic text-neutral-400">Nenhuma perícia.</div>
                            <input type="hidden" name="pericias" id="periciasInput">
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1"><label class="block text-sm font-medium">Vantagens:</label><button type="button" id="manageAdvantagesButton" class="text-sm action-button action-button-secondary px-3 py-1">Gerir Vantagens</button></div>
                            <div id="displayAdvantages" class="p-2 min-h-[40px] bg-neutral-900/50 rounded-md border border-neutral-600 text-sm italic text-neutral-400">Nenhuma vantagem.</div>
                            <input type="hidden" name="vantagens" id="vantagensInput">
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1"><label class="block text-sm font-medium">Desvantagens:</label><button type="button" id="manageDisadvantagesButton" class="text-sm action-button action-button-secondary px-3 py-1">Gerir Desvantagens</button></div>
                            <div id="displayDisadvantages" class="p-2 min-h-[40px] bg-neutral-900/50 rounded-md border border-neutral-600 text-sm italic text-neutral-400">Nenhuma desvantagem.</div>
                            <input type="hidden" name="desvantagens" id="desvantagensInput">
                        </div>
                    </div>
                </fieldset>

                <!-- Seção de Magia -->
                <fieldset id="secao-magia" class="border border-neutral-700 p-4 rounded-md">
                    <legend class="text-lg px-2 section-title !border-none !mb-0 !pb-0 !text-amber-500">🔮 Magia & Rituais</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 my-4">
                        <div>
                            <label for="poderesMagicos" class="block text-sm font-medium text-gray-400 mb-1">Poderes Mágicos (Vantagem)</label>
                            <input type="number" id="poderesMagicos" name="poderesMagicos" class="w-full bg-neutral-900 border-neutral-600 rounded-md p-2" placeholder="1-5" min="0" max="5" value="0">
                            <p class="text-xs text-gray-500 mt-1">Pontos para Caminhos.</p>
                        </div>
                        <div>
                            <label for="tradicaoMagica" class="block text-sm font-medium text-gray-400 mb-1">Tradição Mágica</label>
                            <select id="tradicaoMagica" name="tradicaoMagica" class="w-full bg-neutral-900 border-neutral-600 rounded-md p-2 h-[42px]">
                                <option value="INT">Arcana (INT)</option>
                                <option value="SAB">Divina/Primal (SAB)</option>
                                <option value="POD">Inata (POD)</option>
                            </select>
                             <p class="text-xs text-gray-500 mt-1">Atributo chave.</p>
                        </div>
                        <div>
                            <label for="pontosEnergia" class="block text-sm font-medium text-gray-400 mb-1">Pontos de Energia (PE)</label>
                            <input type="text" id="pontosEnergia" name="pontosEnergia" class="w-full bg-neutral-900 border-neutral-600 rounded-md p-2" readonly>
                            <p class="text-xs text-gray-500 mt-1">Atributo Mágico + CON + 10.</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl content-font text-gray-300 mb-3 border-t border-gray-700 pt-4">Caminhos de Magia</h3>
                        <div id="caminhosContainer" class="space-y-3"></div>
                        <input type="hidden" name="caminhosMagia" id="caminhosMagiaInput">
                        <button type="button" id="addCaminhoBtn" class="mt-4 text-sm bg-red-800 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md shadow-lg transition-colors duration-200">+ Adicionar Caminho</button>
                    </div>
                    <div class="mt-6">
                        <details class="bg-neutral-900/50 p-3 rounded-lg border border-neutral-700">
                            <summary class="cursor-pointer text-lg content-font text-gray-300 hover:text-white">Tabela de Níveis e Limites da Magia</summary>
                            <div class="overflow-x-auto mt-2">
                                <table class="min-w-full text-sm text-left text-gray-400">
                                    <thead class="text-xs text-gray-300 uppercase bg-gray-700/50">
                                        <tr>
                                            <th class="px-4 py-2">Nível</th><th class="px-4 py-2">PE</th><th class="px-4 py-2">Dano</th><th class="px-4 py-2">Bônus/RD</th><th class="px-4 py-2">Alcance/Área</th><th class="px-4 py-2">Duração</th><th class="px-4 py-2">CD</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-700">
                                        <tr class="hover:bg-gray-800/50 text-center"><td>1</td><td>1</td><td>1d6</td><td>+2/RD 2</td><td>Toque/5m</td><td>1d6 R</td><td>8</td></tr>
                                        <tr class="hover:bg-gray-800/50 text-center"><td>2</td><td>2</td><td>2d6</td><td>+4/RD 4</td><td>10m/2x2m</td><td>2d6 R</td><td>10</td></tr>
                                        <tr class="hover:bg-gray-800/50 text-center"><td>3</td><td>3</td><td>3d6</td><td>+6/RD 6</td><td>25m/5x5m</td><td>3d6 R</td><td>12</td></tr>
                                        <tr class="hover:bg-gray-800/50 text-center"><td>4</td><td>4</td><td>4d6</td><td>+8/RD 8</td><td>50m/10x10m</td><td>4d6 R</td><td>14</td></tr>
                                        <tr class="hover:bg-gray-800/50 text-center"><td>5</td><td>5</td><td>5d6</td><td>+10/RD 10</td><td>100m/20x20m</td><td>5d6 R</td><td>16</td></tr>
                                        <tr class="hover:bg-gray-800/50 text-center"><td>6+</td><td>6+</td><td>6d6+</td><td>+12+/RD 12+</td><td>200m+</td><td>Sust.</td><td>18+</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </details>
                    </div>
                </fieldset>

                <div class="flex justify-end mt-6 space-x-4">
                    <button type="button" id="clearFormButton" class="px-6 py-2 action-button action-button-secondary rounded-md shadow-md">Limpar</button>
                    <button type="submit" class="px-6 py-2 action-button action-button-primary rounded-md shadow-md">Salvar e Visualizar</button>
                </div>
            </form>
        </div>
        
        <!-- Seção de Fichas Salvas -->
        <div id="savedSheetsSection" class="w-full bg-neutral-800 p-6 sm:p-8 rounded-lg shadow-2xl mt-10 border border-neutral-700 no-print">
            <h2 class="title-font text-2xl font-bold text-center text-amber-600 mb-4">Crônicas Salvas</h2>
            <div id="savedSheetsList" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                <p class="text-neutral-500 text-center">Nenhuma crônica registrada ainda.</p>
            </div>
        </div>

        <!-- Div para exibir a ficha gerada -->
        <div id="generatedSheet" class="w-full max-w-3xl bg-neutral-800 p-6 sm:p-8 rounded-lg shadow-2xl mt-10 hidden border border-neutral-700">
             <h2 class="section-title text-2xl">Ficha Gerada</h2>
             <div id="sheetContent"></div>
             <button id="printSheetButton" class="no-print mt-4 px-6 py-2 action-button action-button-primary">Imprimir</button>
             <button id="exportSheetButton" class="no-print mt-4 px-6 py-2 action-button action-button-secondary">Exportar JSON</button>
        </div>
    </div>

    <!-- Modal Genérico para Perícias, Vantagens, Desvantagens -->
    <div id="pvdModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 id="pvdModalTitle" class="modal-title">Gerir Itens</h3><button id="closePvdModal" class="modal-close-button" title="Fechar">&times;</button></div>
            <div class="modal-body space-y-4">
                <div id="pvdFormContainer"></div>
                <div id="pvdListContainer" class="max-h-60 overflow-y-auto border border-neutral-700 rounded-md p-2 bg-neutral-800/50"></div>
            </div>
            <div class="mt-6 text-right"><button id="savePvdButton" class="action-button action-button-primary px-4 py-2">Concluir Edição</button></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ELEMENTOS DO DOM ---
        const form = document.getElementById('rpgSheetForm');
        const allAtributosInputs = {
            for: document.getElementById('for'), des: document.getElementById('des'),
            con: document.getElementById('con'), int: document.getElementById('int'),
            sab: document.getElementById('sab'), pod: document.getElementById('pod'),
            car: document.getElementById('car')
        };
        const poderesMagicosInput = document.getElementById('poderesMagicos');
        const tradicaoMagicaSelect = document.getElementById('tradicaoMagica');
        const pontosEnergiaInput = document.getElementById('pontosEnergia');
        const addCaminhoBtn = document.getElementById('addCaminhoBtn');
        const caminhosContainer = document.getElementById('caminhosContainer');
        const caminhosMagiaInput = document.getElementById('caminhosMagiaInput');
        
        const attributePointsValueDiv = document.getElementById('attributePointsValue');
        const skillPointsValueDiv = document.getElementById('skillPointsValue');
        const advantagePointsValueDiv = document.getElementById('advantagePointsValue');
        const magicPathPointsValueDiv = document.getElementById('magicPathPointsValue');
        
        const expInput = document.getElementById('expPoints');
        const earnedAttributePointsDiv = document.getElementById('earnedAttributePoints');
        const earnedEvolutionPointsDiv = document.getElementById('earnedEvolutionPoints');
        const availableEvolutionPointsDiv = document.getElementById('availableEvolutionPoints');
        const spendOnSkillButton = document.getElementById('spendOnSkillButton');
        const spendOnAdvantageButton = document.getElementById('spendOnAdvantageButton');
        const pontosPericiaAdicionaisInput = document.getElementById('pontosPericiaAdicionais');
        const pontosVantagemAdicionaisInput = document.getElementById('pontosVantagemAdicionais');
        
        const manageSkillsButton = document.getElementById('manageSkillsButton');
        const manageAdvantagesButton = document.getElementById('manageAdvantagesButton');
        const manageDisadvantagesButton = document.getElementById('manageDisadvantagesButton');
        const displaySkillsDiv = document.getElementById('displaySkills');
        const displayAdvantagesDiv = document.getElementById('displayAdvantages');
        const displayDisadvantagesDiv = document.getElementById('displayDisadvantages');
        
        const pvdModal = document.getElementById('pvdModal');
        const pvdModalTitle = document.getElementById('pvdModalTitle');
        const closePvdModalButton = document.getElementById('closePvdModal');
        const pvdFormContainer = document.getElementById('pvdFormContainer');
        const pvdListContainer = document.getElementById('pvdListContainer');
        const savePvdButton = document.getElementById('savePvdButton');

        const savedSheetsListDiv = document.getElementById('savedSheetsList');
        const generatedSheetDiv = document.getElementById('generatedSheet');
        const sheetContentDiv = document.getElementById('sheetContent');
        const clearFormButton = document.getElementById('clearFormButton');
        const printSheetButton = document.getElementById('printSheetButton');
        const exportSheetButton = document.getElementById('exportSheetButton');
        const importSheetButton = document.getElementById('importSheetButton');
        const fileInput = document.getElementById('fileInput');

        // --- ESTADO E CONSTANTES ---
        const LOCAL_STORAGE_INDEX_KEY = 'rpgFichasIndex_kuar_tor_v1';
        const LOCAL_STORAGE_SHEET_PREFIX = 'rpgFicha_kuar_tor_v1_';
        let currentSheetId = null;
        let currentEditingPVDType = null;
        let tempPVDList = [];
        const listaPericiasMedieval2D6 = ["Acadêmico", "Acrobata", "Arqueiro", "Artífice", "Atletismo", "Cavalgar", "Curandeiro", "Disciplina", "Dissimular", "Domador", "Empatia", "Erudição", "Expressão", "Furtivo", "Guerreiro", "Ladino", "Linguística", "Manha", "Manipulação", "Mecânico", "Navegador", "Ocultismo", "Percepção", "Performance", "Presença", "Sobrevivência"];
        const caminhosDisponiveis = ["Magia (Fogo)", "Magia (Água)", "Magia (Ar)", "Magia (Terra)", "Magia (Luz)", "Magia (Trevas)", "Magia (Animais)", "Magia (Plantas)", "Magia (Humanos)", "Magia (Spiritum)", "Magia (Arkanum)", "Magia (Metamagia)"];

        // --- FUNÇÕES ---
        
        function updateAllStats() {
            // Cálculos de Pontos de Evolução
            const exp = parseInt(expInput.value) || 0;
            const pontosPericiaAdd = parseInt(pontosPericiaAdicionaisInput.value) || 0;
            const pontosVantagemAdd = parseInt(pontosVantagemAdicionaisInput.value) || 0;
            const attributePointsEarned = Math.floor(exp / 20);
            const evolutionPointsEarned = Math.floor(exp / 5);
            const evolutionPointsSpent = pontosPericiaAdd + pontosVantagemAdd;
            const evolutionPointsAvailable = evolutionPointsEarned - evolutionPointsSpent;
            earnedAttributePointsDiv.textContent = attributePointsEarned;
            earnedEvolutionPointsDiv.textContent = evolutionPointsEarned;
            availableEvolutionPointsDiv.textContent = evolutionPointsAvailable;
            spendOnSkillButton.disabled = evolutionPointsAvailable <= 0;
            spendOnAdvantageButton.disabled = evolutionPointsAvailable <= 0;

            // Contador de Pontos de Atributos
            const totalAttributePoints = 12 + attributePointsEarned;
            let attributesSpent = 0;
            Object.values(allAtributosInputs).forEach(input => { attributesSpent += parseInt(input.value) || 0; });
            attributePointsValueDiv.textContent = `${attributesSpent}/${totalAttributePoints}`;
            attributePointsValueDiv.classList.toggle('negative', attributesSpent > totalAttributePoints);

            // Contador de Pontos de Perícia
            const totalSkillPoints = 10 + pontosPericiaAdd;
            const skills = JSON.parse(document.getElementById('periciasInput').value || '[]');
            const skillsSpent = skills.reduce((total, skill) => total + (skill.valor || 0), 0);
            skillPointsValueDiv.textContent = `${skillsSpent}/${totalSkillPoints}`;
            skillPointsValueDiv.classList.toggle('negative', skillsSpent > totalSkillPoints);

            // Contador de Vantagens/Desvantagens
            const advantages = JSON.parse(document.getElementById('vantagensInput').value || '[]');
            const disadvantages = JSON.parse(document.getElementById('desvantagensInput').value || '[]');
            const advantagesSpent = advantages.reduce((total, adv) => total + (adv.custo || 0), 0);
            const disadvantagesBonus = disadvantages.reduce((total, dis) => total + (dis.bonus || 0), 0);
            const advantagePointsPool = Math.min(disadvantagesBonus, 3) + pontosVantagemAdd;
            advantagePointsValueDiv.textContent = `${advantagesSpent}/${advantagePointsPool}`;
            advantagePointsValueDiv.classList.toggle('negative', advantagesSpent > advantagePointsPool);

            // Cálculos de Magia
            const con = parseInt(allAtributosInputs.con.value) || 0;
            const tradicao = tradicaoMagicaSelect.value;
            let atributoMagicoVal = 0;
            if (tradicao === 'INT') atributoMagicoVal = parseInt(allAtributosInputs.int.value) || 0;
            else if (tradicao === 'SAB') atributoMagicoVal = parseInt(allAtributosInputs.sab.value) || 0;
            else if (tradicao === 'POD') atributoMagicoVal = parseInt(allAtributosInputs.pod.value) || 0;
            pontosEnergiaInput.value = atributoMagicoVal + con + 10;
            
            const pontosDisponiveisCaminho = parseInt(poderesMagicosInput.value) || 0;
            let pontosGastosCaminho = 0;
            caminhosContainer.querySelectorAll('input[type="number"]').forEach(input => {
                pontosGastosCaminho += parseInt(input.value) || 0;
            });
            magicPathPointsValueDiv.textContent = `${pontosGastosCaminho}/${pontosDisponiveisCaminho}`;
            magicPathPointsValueDiv.classList.toggle('negative', pontosGastosCaminho > pontosDisponiveisCaminho);
        }

        function adicionarCaminho(caminhoData = { nome: '', nivel: 0 }) {
            const id = Date.now();
            const div = document.createElement('div');
            div.className = 'grid grid-cols-[1fr,auto,1fr,auto] gap-x-3 items-center p-2 bg-neutral-900/50 rounded-md border border-neutral-700';
            
            const optionsHtml = caminhosDisponiveis.map(c => `<option value="${c}" ${c === caminhoData.nome ? 'selected' : ''}>${c}</option>`).join('');
            div.innerHTML = `
                <select name="caminho-nome-${id}" class="w-full bg-neutral-700 border border-neutral-600 rounded-md h-10 px-2 text-sm">
                    <option value="">-- Escolha um Caminho --</option>
                    ${optionsHtml}
                </select>
                <input type="number" name="caminho-nivel-${id}" class="attribute-input w-16" placeholder="Nvl" min="0" value="${caminhoData.nivel || 0}">
                <p name="caminho-formas-${id}" class="text-sm text-gray-400">Formas: -</p>
                <button type="button" class="remove-caminho-btn text-gray-400 hover:text-red-500 transition-colors no-print">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                </button>
            `;
            caminhosContainer.appendChild(div);

            const nivelInput = div.querySelector(`input[name="caminho-nivel-${id}"]`);
            const formasDisplay = div.querySelector(`p[name="caminho-formas-${id}"]`);
            
            nivelInput.addEventListener('input', () => {
                atualizarFormas(nivelInput, formasDisplay);
                updateAllStats();
            });
            div.querySelector('.remove-caminho-btn').addEventListener('click', () => {
                div.remove();
                updateAllStats();
            });
            
            atualizarFormas(nivelInput, formasDisplay);
        }
        
        function atualizarFormas(nivelInput, formasDisplay) {
            const nivel = parseInt(nivelInput.value) || 0;
            let formasTexto = "Formas: ";
            if (nivel >= 3) formasTexto += '<span class="text-green-400">Entender</span>, <span class="text-yellow-400">Controlar</span>, <span class="text-red-400">Criar</span>';
            else if (nivel === 2) formasTexto += '<span class="text-green-400">Entender</span>, <span class="text-yellow-400">Controlar</span>';
            else if (nivel === 1) formasTexto += '<span class="text-green-400">Entender</span>';
            else formasTexto += "-";
            formasDisplay.innerHTML = formasTexto;
        }

        function openPVDModal(type) {
            currentEditingPVDType = type;
            tempPVDList = JSON.parse(document.getElementById(type + 'Input').value || '[]');
            let title = "";
            let formHtml = "";

            if (type === 'pericias') {
                title = "Gerir Perícias";
                formHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
                        <div>
                            <label for="pvdSkillSelect" class="block text-xs font-medium text-neutral-400">Perícia:</label>
                            <select id="pvdSkillSelect" class="mt-1 block w-full p-2 text-sm bg-neutral-700 border-neutral-600 rounded-md"><option value="">-- Selecione --</option>${listaPericiasMedieval2D6.map(p => `<option value="${p}">${p}</option>`).join('')}<option value="OUTRA">Outra...</option></select>
                        </div>
                        <div id="pvdCustomNameContainer" class="hidden md:col-span-2"><label for="pvdName" class="block text-xs font-medium text-neutral-400">Nome da Perícia Personalizada:</label><input type="text" id="pvdName" class="mt-1 block w-full p-2 text-sm bg-neutral-700 border-neutral-600 rounded-md"></div>
                        <div><label for="pvdValue" class="block text-xs font-medium text-neutral-400">Valor (1-5):</label><input type="number" id="pvdValue" min="1" max="5" value="1" class="mt-1 block w-full p-2 text-sm bg-neutral-700 border-neutral-600 rounded-md"></div>
                        <div class="md:col-span-2"><label for="pvdAttribute" class="block text-xs font-medium text-neutral-400">Atributo Base:</label><select id="pvdAttribute" class="mt-1 block w-full p-2 text-sm bg-neutral-700 border-neutral-600 rounded-md">${Object.keys(allAtributosInputs).map(attr => `<option value="${attr.toUpperCase()}">${attr.toUpperCase()}</option>`).join('')}</select></div>
                        <div class="md:col-span-2"><label for="pvdDescription" class="block text-xs font-medium text-neutral-400">Descrição/Notas:</label><input type="text" id="pvdDescription" class="mt-1 block w-full p-2 text-sm bg-neutral-700 border-neutral-600 rounded-md"></div>
                    </div>
                    <button type="button" id="addPvdItemButton" class="mt-3 action-button action-button-main px-3 py-1 text-sm">Adicionar Perícia</button>`;
            } else if (type === 'vantagens' || type === 'desvantagens') {
                const isAdvantage = type === 'vantagens';
                title = isAdvantage ? "Gerir Vantagens" : "Gerir Desvantagens";
                const costOrBonus = isAdvantage ? 'Custo' : 'Bônus';
                formHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
                        <div><label for="pvdName" class="block text-xs font-medium text-neutral-400">Nome:</label><input type="text" id="pvdName" class="mt-1 block w-full p-2 text-sm bg-neutral-700 border-neutral-600 rounded-md"></div>
                        <div><label for="pvdCost" class="block text-xs font-medium text-neutral-400">${costOrBonus} (1-5):</label><input type="number" id="pvdCost" min="1" max="5" value="1" class="mt-1 block w-full p-2 text-sm bg-neutral-700 border-neutral-600 rounded-md"></div>
                        <div class="md:col-span-2"><label for="pvdDescription" class="block text-xs font-medium text-neutral-400">Descrição:</label><textarea id="pvdDescription" rows="2" class="mt-1 block w-full p-2 text-sm bg-neutral-700 border-neutral-600 rounded-md"></textarea></div>
                    </div>
                    <button type="button" id="addPvdItemButton" class="mt-3 action-button action-button-main px-3 py-1 text-sm">Adicionar ${isAdvantage ? 'Vantagem' : 'Desvantagem'}</button>`;
            }

            pvdModalTitle.textContent = title;
            pvdFormContainer.innerHTML = formHtml;
            renderPVDList();
            pvdModal.classList.remove('hidden');

            if (type === 'pericias') {
                const skillSelect = document.getElementById('pvdSkillSelect');
                const customNameContainer = document.getElementById('pvdCustomNameContainer');
                skillSelect.addEventListener('change', () => customNameContainer.classList.toggle('hidden', skillSelect.value !== 'OUTRA'));
            }
            document.getElementById('addPvdItemButton').addEventListener('click', addPvdItem);
        }

        function addPvdItem() {
            let name, value, cost, bonus, description, atributo;
            const nameInput = document.getElementById('pvdName');
            const descInput = document.getElementById('pvdDescription');
            
            if (currentEditingPVDType === 'pericias') {
                const skillSelect = document.getElementById('pvdSkillSelect');
                name = skillSelect.value === 'OUTRA' ? nameInput.value.trim() : skillSelect.value;
                value = parseInt(document.getElementById('pvdValue').value);
                atributo = document.getElementById('pvdAttribute').value;
                description = descInput.value.trim();
                if (!name || isNaN(value)) return;
                tempPVDList.push({ id: Date.now(), nome: name, valor: value, atributo: atributo, descricao: description });
            } else {
                name = nameInput.value.trim();
                cost = parseInt(document.getElementById('pvdCost').value);
                description = descInput.value.trim();
                if (!name || isNaN(cost)) return;
                const item = { id: Date.now(), nome: name, descricao: description };
                if (currentEditingPVDType === 'vantagens') item.custo = cost;
                else item.bonus = cost;
                tempPVDList.push(item);
            }
            renderPVDList();
            pvdFormContainer.querySelector('form, div').reset?.();
        }

        function removePvdItem(id) {
            tempPVDList = tempPVDList.filter(item => item.id != id);
            renderPVDList();
        }

        function renderPVDList() {
            pvdListContainer.innerHTML = tempPVDList.map(item => {
                let text = `<strong>${item.nome}</strong>`;
                if (item.valor) text += ` (${item.atributo}: ${item.valor})`;
                if (item.custo) text += ` (Custo: ${item.custo})`;
                if (item.bonus) text += ` (Bônus: ${item.bonus})`;
                if (item.descricao) text += `<span class="description">${item.descricao}</span>`;
                return `<div class="pvd-item"><div class="pvd-item-details flex-grow">${text}</div><button type="button" data-id="${item.id}" class="remove-pvd-item-btn text-red-500 hover:text-red-400 font-bold text-xs ml-2 p-1">X</button></div>`;
            }).join('') || `<p class="text-sm text-neutral-500">Nenhum item.</p>`;
            pvdListContainer.querySelectorAll('.remove-pvd-item-btn').forEach(btn => btn.addEventListener('click', e => removePvdItem(e.target.dataset.id)));
        }
        
        function savePVDChanges() {
            document.getElementById(currentEditingPVDType + 'Input').value = JSON.stringify(tempPVDList);
            pvdModal.classList.add('hidden');
            updateDisplayPVDs();
            updateAllStats();
        }
        
        function updateDisplayPVDs() {
            const pericias = JSON.parse(document.getElementById('periciasInput').value || '[]');
            const vantagens = JSON.parse(document.getElementById('vantagensInput').value || '[]');
            const desvantagens = JSON.parse(document.getElementById('desvantagensInput').value || '[]');
            displaySkillsDiv.innerHTML = pericias.map(p => `<span>${p.nome} (${p.atributo}: ${p.valor})</span>`).join('; ') || '<span class="italic text-neutral-500">Nenhuma perícia.</span>';
            displayAdvantagesDiv.innerHTML = vantagens.map(v => `<span>${v.nome} (Custo: ${v.custo})</span>`).join('; ') || '<span class="italic text-neutral-500">Nenhuma vantagem.</span>';
            displayDisadvantagesDiv.innerHTML = desvantagens.map(d => `<span>${d.nome} (Bônus: ${d.bonus})</span>`).join('; ') || '<span class="italic text-neutral-500">Nenhuma desvantagem.</span>';
        }

        function getFormAsJson() {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const caminhos = [];
            caminhosContainer.querySelectorAll('.grid').forEach(caminhoDiv => {
                const nome = caminhoDiv.querySelector('select').value;
                const nivel = parseInt(caminhoDiv.querySelector('input[type="number"]').value) || 0;
                if (nome && nivel > 0) caminhos.push({ nome, nivel });
            });
            data.caminhosMagia = caminhos;
            return JSON.stringify(data);
        }

        function loadFormFromJson(jsonString) {
            const data = JSON.parse(jsonString);
            for (const key in data) {
                const element = form.elements[key];
                if (element) {
                    if (element.type === 'checkbox') element.checked = data[key];
                    else element.value = data[key];
                }
            }
            caminhosContainer.innerHTML = '';
            if (data.caminhosMagia) {
                data.caminhosMagia.forEach(caminho => adicionarCaminho(caminho));
            }
            updateDisplayPVDs();
            updateAllStats();
        }
        
        // --- EVENT LISTENERS ---
        Object.values(allAtributosInputs).forEach(input => input.addEventListener('input', updateAllStats));
        poderesMagicosInput.addEventListener('input', updateAllStats);
        tradicaoMagicaSelect.addEventListener('input', updateAllStats);
        addCaminhoBtn.addEventListener('click', () => adicionarCaminho());
        expInput.addEventListener('input', updateAllStats);
        spendOnSkillButton.addEventListener('click', () => { pontosPericiaAdicionaisInput.value++; updateAllStats(); });
        spendOnAdvantageButton.addEventListener('click', () => { pontosVantagemAdicionaisInput.value++; updateAllStats(); });
        manageSkillsButton.addEventListener('click', () => openPVDModal('pericias'));
        manageAdvantagesButton.addEventListener('click', () => openPVDModal('vantagens'));
        manageDisadvantagesButton.addEventListener('click', () => openPVDModal('desvantagens'));
        closePvdModalButton.addEventListener('click', () => pvdModal.classList.add('hidden'));
        savePvdButton.addEventListener('click', savePVDChanges);

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const data = JSON.parse(getFormAsJson());
            let sheetHtml = `<h3>Identidade</h3><p><strong>Nome:</strong> ${data.charName || 'N/A'}</p><p><strong>Raça:</strong> ${data.charRace || 'N/A'}</p><p><strong>Classe:</strong> ${data.charClass || 'N/A'}</p>`;
            sheetHtml += `<h3 class="mt-4">Atributos</h3><div class="grid grid-cols-4 gap-2">${Object.keys(allAtributosInputs).map(attr => `<p><strong>${attr.toUpperCase()}:</strong> ${data[attr] || 0}</p>`).join('')}</div>`;
            sheetHtml += `<h3 class="mt-4">Magia</h3><p><strong>Tradição:</strong> ${data.tradicaoMagica}</p><p><strong>PEs:</strong> ${data.pontosEnergia}</p><h4>Caminhos:</h4>`;
            sheetHtml += data.caminhosMagia.length > 0 ? `<ul>${data.caminhosMagia.map(c => `<li>${c.nome} (Nível ${c.nivel})</li>`).join('')}</ul>` : '<p>Nenhum.</p>';
            sheetContentDiv.innerHTML = sheetHtml;
            generatedSheetDiv.classList.remove('hidden');
        });

        clearFormButton.addEventListener('click', () => {
            form.reset();
            caminhosContainer.innerHTML = '';
            ['periciasInput', 'vantagensInput', 'desvantagensInput'].forEach(id => document.getElementById(id).value = '');
            updateDisplayPVDs();
            updateAllStats();
            generatedSheetDiv.classList.add('hidden');
        });

        printSheetButton.addEventListener('click', () => window.print());
        exportSheetButton.addEventListener('click', () => {
            const json = getFormAsJson();
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${form.elements.charName.value || 'personagem'}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });
        importSheetButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => loadFormFromJson(event.target.result);
                reader.readAsText(file);
            }
        });

        // --- INICIALIZAÇÃO ---
        updateAllStats();
    });
    </script>
</body>
</html>
